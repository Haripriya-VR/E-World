<%-include('../partials/userheader') %>


  <body style=" background-color: #D5E6E5;">

    <form id="checkout-form">
      <div class="container row m-auto my-5 p-5 order-container w-35">

        <div class="col">
          <% if (Address && Address.length> 0) { %>
            <% Address.forEach((item, index)=> { %>
              <div style="background-color: #bcbcbc62; padding: 20px;" class="row pl-lg-5 address mb-4">
                <label for="address-<%= item._id %>">
                  <input type="radio" id="address-<%= item._id %>" name="addressId" value="<%= item._id %>" <% if
                    (index===0) { %>checked<% } %>
                    >
                    <%= `${item.fullName}, ${item.mobile}, ${item.street}, ${item.village}, ${item.city}, Near
                      ${item.landmark}, PIN Code: ${item.pinCode}, ${item.state}` %>
                </label>
              </div>
              <% }); %>
                <% } %>

                  <a href="/checkout-addAddress" class="text-decoration-none">
                    <h5>Add Address</h5>
                  </a>
        </div>
        <div class="col">

          <h3>Your Order</h3>
          <hr>
          <div class="d-flex justify-content-between">
            <h5 class="fw-bold">Product</h5>
            <h5 class="fw-bold">Total</h5>
          </div>

          <% if (products && products.length> 0) { %>
            <% products.forEach(item=> { %>
              <ul class="list-unstyled">
                <li class="pt-2 d-flex justify-content-between">
                  <%= item.productId.name %> <span class="text-dark">₹ <%= item.quantity * item.productId.price %>
                    </span>
                </li>
              </ul>
              <hr>
              <% }); %>

                <ul class="list-unstyled">
                  <li class="pt-2 d-flex justify-content-between">
                    Subtotal <span class="text-dark">₹ <%= cartTotal %></span>
                  </li>
                  <li class="pt-2 d-flex justify-content-between">
                    Coupon Discount <span class="text-dark">₹ 0</span>
                  </li>
                  <li class="pt-2 d-flex justify-content-between">
                    Total <span class="text-dark">₹ <%= cartTotal %></span>
                  </li>
                </ul>

                <% } else { %>
                  <p>Your cart is empty.</p>
                  <% } %>

                    <div>
                      <hr>
                      <h5 class="fw-bold mb-3">Payment Methods</h5>
                      <div>
                        <input type="radio" name="paymentMethod" id="COD" value="COD" checked>
                        <label for="COD">Cash on delivery</label>
                      </div>
                      <div>
                        <input type="radio" name="paymentMethod" id="Razorpay" value="Razorpay">
                        <label for="Razorpay">Razorpay</label>

                      </div>
                      <br>
                      <!-- <a href="/place-order" class="btn btn-info fw-bold w-100 ">place order</a> -->
                      <button onclick="submitForm()" class="btn btn-info fw-bold w-100 ">PLACE ORDER</button>
                    </div>
        </div>
    </form>
    </div>
  </body>




  <!-- razorpay -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <script>

    async function submitForm() {

      try {
        const addressRadio = document.querySelector('input[name="addressId"]:checked');
        const paymentMethodRadio = document.querySelector('input[name="paymentMethod"]:checked');

        if (!addressRadio || !paymentMethodRadio) {
          alert("Please select an address and payment method.");
          return;
        }

        const addressId = addressRadio.value;
        const paymentMethod = paymentMethodRadio.value;
        const orderStatus = 'pending';

        $("#checkout-form").submit((e) => {
          e.preventDefault();
          $.ajax({
            url: '/place-order',
            method: 'post',
            data: { addressId, paymentMethod, orderStatus },
            success: (response) => {
              if (response.codSuccess) {
                window.location.href = '/order-confirmed';
              } else {
                razorpayPayment(response.payment);
              }
            }
          });
        });
      } catch (error) {
        console.error("Error in submitForm:", error);
      }
    }

    function razorpayPayment(order) {

      var options = {
        "key": "rzp_test_iF7sA4HkDUGfBw",
        "amount": order.amount,
        "currency": "INR",
        "name": "E-World",
        "description": "Test Transaction",
        "image": "https://example.com/your_logo",
        "order_id": order.id,
        "handler": function (response) {
          // alert(response.razorpay_payment_id);
          // alert(response.razorpay_order_id);
          // alert(response.razorpay_signature)

          verifypayment(response, order)
        },
        "notes": {
          "address": "Razorpay Corporate Office"
        },
        "theme": {
          "color": "#3399cc"
        }
      };
      var rzp1 = new Razorpay(options);
      rzp1.open();
    }

    function verifypayment(payment, order) {
      $.ajax({
        url: '/verify-payment',
        data: {
          payment,
          order,
        },
        method: 'post',
      });
    }

  </script>